<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAMDP ‚Äî Epics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', system-ui, sans-serif; }
    .card { @apply bg-white rounded-xl shadow-md p-6 border border-gray-100 transition-shadow; }
    .card:hover { box-shadow: 0 4px 24px rgba(0,83,226,0.08); }
    .kpi-value { @apply text-3xl md:text-4xl font-bold; }
    .kpi-label { @apply text-xs text-gray-500 mt-1 uppercase tracking-wide; }
    .badge { @apply px-2.5 py-0.5 rounded-full text-xs font-semibold inline-block; }
    .badge-wip { @apply bg-blue-100 text-blue-800; }
    .badge-done { @apply bg-green-100 text-green-800; }
    .badge-blocked { @apply bg-red-100 text-red-800; }
    .badge-backlog { @apply bg-gray-100 text-gray-700; }
    .filter-pill { @apply px-3 py-1 rounded-full text-xs font-medium cursor-pointer border transition-all; }
    .filter-pill.active { @apply bg-gray-700 text-white border-gray-700; }
    .filter-pill:not(.active) { @apply bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200 hover:text-gray-700; }
    .domain-btn { @apply px-4 py-2 text-sm font-semibold rounded-lg border-2 transition-all; }
    .domain-btn.active { background:#0053e2; border-color:#0053e2; color:white; box-shadow:0 2px 8px rgba(0,83,226,0.3); }
    .domain-btn:not(.active) { background:white; border-color:#e5e7eb; color:#4b5563; }
    .domain-btn:not(.active):hover { border-color:#0053e2; color:#0053e2; background:#eff6ff; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .slicer-select { @apply border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2; --tw-ring-color:#0053e2; }
    .epic-filter-badge { @apply inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold cursor-pointer transition-all; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header style="background:#0053e2" class="text-white py-6 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">‚ö° CAMDP Epics Dashboard</h1>
        <p class="text-blue-200 text-sm mt-1">Centro de Anal√≠tica, Machine Learning & Data Platform</p>
      </div>
      <div class="text-right text-sm text-blue-200 space-y-0.5">
        <p>Generado: <span class="text-white">{{ generated_at }}</span></p>
        <p>√âpicas: <span class="text-white font-bold">{{ total_epics }}</span>
           &bull; Issues: <span class="text-white font-bold">{{ total_all_issues }}</span>
           <span class="text-blue-300 text-xs">(updated ‚â• 05-Ene-2026)</span></p>
      </div>
    </div>
  </header>

  <!-- DOMAIN TABS -->
  <nav class="bg-white shadow-sm border-b sticky top-0 z-50 py-3" aria-label="Dominios">
    <div class="max-w-7xl mx-auto px-4 flex flex-wrap gap-2">
      <button class="domain-btn active" data-tab="general" onclick="switchTab('general')">üåê General</button>
      {% for dom in domains %}
      <button class="domain-btn" data-tab="{{ dom.slug }}" onclick="switchTab('{{ dom.slug }}')">
        {{ dom.name }} <span class="opacity-60 text-xs">({{ dom.total_issues }})</span>
      </button>
      {% endfor %}
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8">

    <!-- ==================== TAB: GENERAL ==================== -->
    <div id="tab-general" class="tab-content active space-y-6">

      <!-- KPIs -->
      <section class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4">
        <div class="card text-center"><div class="kpi-value" style="color:#0053e2">{{ total_epics }}</div><div class="kpi-label">√âpicas</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#2a8703">{{ resolution.resolved }}</div><div class="kpi-label">Resueltas</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#0053e2">{{ active_epics|length }}</div><div class="kpi-label">En Progreso</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#ea1100">{{ blocked_epics|length }}</div><div class="kpi-label">Bloqueadas</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#995213">{{ total_all_issues }}</div><div class="kpi-label">Issues</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#2a8703">{{ resolution.rate_pct }}%</div><div class="kpi-label">Resoluci√≥n</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#6366f1">{{ avg_cycle_time }}d</div><div class="kpi-label">Cycle Time</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#f97316">{{ avg_lead_time }}d</div><div class="kpi-label">Lead Time</div></div>
      </section>

      <!-- Insights -->
      <section class="card" style="border-left:4px solid #0053e2">
        <h2 class="text-lg font-bold mb-2" style="color:#0053e2">üìä An√°lisis Ejecutivo</h2>
        <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
          <li><strong>{{ total_all_issues }}</strong> issues (updated ‚â• 05-Ene-2026) &bull; <strong>{{ total_epics }}</strong> √©picas relevantes</li>
          <li>Cycle Time promedio: <strong>{{ avg_cycle_time }} d√≠as</strong> &bull; Lead Time promedio: <strong>{{ avg_lead_time }} d√≠as</strong></li>
          {% if blocked_epics|length > 0 %}
          <li class="text-red-700">‚ö†Ô∏è <strong>{{ blocked_epics|length }}</strong> bloqueada(s):
            {% for e in blocked_epics %}<code class="bg-red-50 px-1 rounded">{{ e.key }}</code>{% if not loop.last %}, {% endif %}{% endfor %}
          </li>
          {% endif %}
          <li>üí° <em>Usa el segmentador de semana y haz clic en las barras del Gantt para filtrar.</em></li>
        </ul>
      </section>

      <!-- Gantt General -->
      <section class="card">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
          <div>
            <h3 class="font-bold text-lg" style="color:#0053e2">üìÖ Gantt ‚Äî Timeline General</h3>
            <p class="text-xs text-gray-400 mt-1">
              L√≠nea roja = hoy &nbsp;|&nbsp;
              <span style="color:#2a8703">‚óè En tiempo</span> &nbsp;
              <span style="color:#0053e2">‚óè Extendida</span> &nbsp;
              <span style="color:#ea1100">‚óè Bloqueada</span>
              &nbsp;|&nbsp; üëâ <em>Haz clic en una barra para filtrar los gr√°ficos</em>
            </p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button class="gantt-pill filter-pill active" data-domain="general" data-status="all" onclick="setGanttFilter('general','all')">Todos</button>
            <button class="gantt-pill filter-pill" data-domain="general" data-status="Work in Progress" onclick="setGanttFilter('general','Work in Progress')">En Progreso</button>
            <button class="gantt-pill filter-pill" data-domain="general" data-status="Blocked" onclick="setGanttFilter('general','Blocked')">Bloqueadas</button>
          </div>
        </div>
        <div style="max-height:900px; overflow-y:auto;">
          <div id="ganttContainer-general" style="min-height:280px;"><canvas id="ganttChart-general"></canvas></div>
        </div>
      </section>

      <!-- SLICER DE SEMANA + EPIC FILTER (mostrado al hacer clic en Gantt) -->
      <section class="flex flex-wrap items-center gap-4" id="slicerBar-general">
        <div class="flex items-center gap-2">
          <label class="text-sm font-semibold text-gray-600">üìÜ Semana (updated):</label>
          <select class="slicer-select week-slicer" data-domain="general">
            <option value="all">Todas las semanas</option>
            {% for w in weeks %}
            <option value="{{ w }}">{{ w }}</option>
            {% endfor %}
          </select>
        </div>
        <div id="epicFilter-general" class="hidden">
          <span class="epic-filter-badge bg-blue-100 text-blue-800" id="epicBadge-general">
            üéØ Filtrando: <span id="epicName-general"></span>
            <button onclick="clearEpicFilter('general')" class="ml-1 text-blue-500 hover:text-red-600 font-bold" aria-label="Quitar filtro">&times;</button>
          </span>
        </div>
      </section>

      <!-- Charts: Servicio + Status -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card"><h3 class="font-bold mb-3" style="color:#0053e2">‚öôÔ∏è Tickets por Servicio</h3><div style="height:300px"><canvas id="serviceChart-general"></canvas></div></div>
        <div class="card"><h3 class="font-bold mb-3" style="color:#0053e2">üü¢ Estado</h3><div style="height:300px"><canvas id="statusChart-general"></canvas></div></div>
      </section>

      <!-- Control Charts -->
      <section class="card">
        <h3 class="font-bold mb-1" style="color:#6366f1">‚è±Ô∏è Cycle Time <span class="text-xs font-normal text-gray-400">(d√≠as por ticket ‚Äî Start ‚Üí Resoluci√≥n)</span></h3>
        <div style="height:320px"><canvas id="cycleTimeChart-general"></canvas></div>
      </section>
      <section class="card">
        <h3 class="font-bold mb-1" style="color:#f97316">üìà Lead Time <span class="text-xs font-normal text-gray-400">(d√≠as por ticket ‚Äî Creaci√≥n ‚Üí Resoluci√≥n)</span></h3>
        <div style="height:320px"><canvas id="leadTimeChart-general"></canvas></div>
      </section>

      <!-- Epic Table -->
      <section class="card">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
          <h2 class="text-lg font-bold" style="color:#0053e2">üìù √âpicas ({{ total_epics }})</h2>
          <input id="searchInput-general" type="text" placeholder="Buscar..." class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 w-full sm:w-72" style="--tw-ring-color:#0053e2" />
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" id="epicTable-general">
            <thead><tr class="text-left text-gray-500 border-b text-xs uppercase tracking-wide">
              <th class="py-2 pr-3">Key</th><th class="pr-3">Summary</th><th class="pr-3">Status</th>
              <th class="pr-3">Dominio</th><th class="pr-3">Servicio</th><th class="pr-3">Assignee</th><th class="pr-3">Creada</th>
            </tr></thead>
            <tbody>
            {% for e in epics %}
            <tr class="border-t border-gray-100 hover:bg-blue-50 cursor-pointer" onclick="window.open('{{ e.url }}','_blank')">
              <td class="py-2 pr-3 font-mono text-xs"><a href="{{ e.url }}" target="_blank" class="underline" style="color:#0053e2">{{ e.key }}</a></td>
              <td class="pr-3">{{ e.summary }}</td>
              <td class="pr-3">{% if e.status == 'Listo' %}<span class="badge badge-done">{{ e.status }}</span>{% elif e.status == 'Blocked' %}<span class="badge badge-blocked">{{ e.status }}</span>{% else %}<span class="badge badge-wip">{{ e.status }}</span>{% endif %}</td>
              <td class="pr-3 text-xs">{{ e.dominio or '-' }}</td>
              <td class="pr-3 text-xs">{{ e.servicio or '-' }}</td>
              <td class="pr-3 text-xs">{{ e.assignee }}</td>
              <td class="pr-3 text-xs">{{ e.created }}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- ==================== DOMAIN TABS ==================== -->
    {% for dom in domains %}
    <div id="tab-{{ dom.slug }}" class="tab-content space-y-6">

      <!-- KPIs -->
      <section class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4">
        <div class="card text-center"><div class="kpi-value" style="color:#0053e2">{{ dom.total_epics }}</div><div class="kpi-label">√âpicas</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#2a8703">{{ dom.resolved }}</div><div class="kpi-label">Resueltas</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#0053e2">{{ dom.active }}</div><div class="kpi-label">En Progreso</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#ea1100">{{ dom.blocked }}</div><div class="kpi-label">Bloqueadas</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#995213">{{ dom.total_issues }}</div><div class="kpi-label">Issues</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#2a8703">{{ dom.resolution_rate }}%</div><div class="kpi-label">Resoluci√≥n</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#6366f1">{{ dom.avg_cycle_time }}d</div><div class="kpi-label">Cycle Time</div></div>
        <div class="card text-center"><div class="kpi-value" style="color:#f97316">{{ dom.avg_lead_time }}d</div><div class="kpi-label">Lead Time</div></div>
      </section>

      <!-- Gantt -->
      {% if dom.gantt %}
      <section class="card">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
          <div>
            <h3 class="font-bold text-lg" style="color:#0053e2">üìÖ Gantt ‚Äî {{ dom.name }}</h3>
            <p class="text-xs text-gray-400 mt-1">
              <span style="color:#2a8703">‚óè En tiempo</span> &nbsp;
              <span style="color:#0053e2">‚óè Extendida</span> &nbsp;
              <span style="color:#ea1100">‚óè Bloqueada</span>
              &nbsp;|&nbsp; üëâ <em>Clic en barra = filtrar gr√°ficos</em>
            </p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button class="gantt-pill filter-pill active" data-domain="{{ dom.slug }}" data-status="all" onclick="setGanttFilter('{{ dom.slug }}','all')">Todos</button>
            <button class="gantt-pill filter-pill" data-domain="{{ dom.slug }}" data-status="Work in Progress" onclick="setGanttFilter('{{ dom.slug }}','Work in Progress')">En Progreso</button>
            <button class="gantt-pill filter-pill" data-domain="{{ dom.slug }}" data-status="Blocked" onclick="setGanttFilter('{{ dom.slug }}','Blocked')">Bloqueadas</button>
          </div>
        </div>
        <div style="max-height:700px; overflow-y:auto;">
          <div id="ganttContainer-{{ dom.slug }}" style="min-height:280px;"><canvas id="ganttChart-{{ dom.slug }}"></canvas></div>
        </div>
      </section>
      {% endif %}

      <!-- SLICER -->
      <section class="flex flex-wrap items-center gap-4" id="slicerBar-{{ dom.slug }}">
        <div class="flex items-center gap-2">
          <label class="text-sm font-semibold text-gray-600">üìÜ Semana:</label>
          <select class="slicer-select week-slicer" data-domain="{{ dom.slug }}">
            <option value="all">Todas</option>
            {% for w in dom.weeks %}<option value="{{ w }}">{{ w }}</option>{% endfor %}
          </select>
        </div>
        <div id="epicFilter-{{ dom.slug }}" class="hidden">
          <span class="epic-filter-badge bg-blue-100 text-blue-800">
            üéØ Filtrando: <span id="epicName-{{ dom.slug }}"></span>
            <button onclick="clearEpicFilter('{{ dom.slug }}')" class="ml-1 text-blue-500 hover:text-red-600 font-bold" aria-label="Quitar filtro">&times;</button>
          </span>
        </div>
      </section>

      <!-- Charts: Servicio + Status -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card"><h3 class="font-bold mb-3" style="color:#0053e2">‚öôÔ∏è Tickets por Servicio</h3><div style="height:300px"><canvas id="serviceChart-{{ dom.slug }}"></canvas></div></div>
        <div class="card"><h3 class="font-bold mb-3" style="color:#0053e2">üü¢ Estado</h3><div style="height:300px"><canvas id="statusChart-{{ dom.slug }}"></canvas></div></div>
      </section>

      <!-- Control Charts -->
      <section class="card">
        <h3 class="font-bold mb-1" style="color:#6366f1">‚è±Ô∏è Cycle Time <span class="text-xs font-normal text-gray-400">(d√≠as por ticket)</span></h3>
        <div style="height:320px"><canvas id="cycleTimeChart-{{ dom.slug }}"></canvas></div>
      </section>
      <section class="card">
        <h3 class="font-bold mb-1" style="color:#f97316">üìà Lead Time <span class="text-xs font-normal text-gray-400">(d√≠as por ticket)</span></h3>
        <div style="height:320px"><canvas id="leadTimeChart-{{ dom.slug }}"></canvas></div>
      </section>

      <!-- Blocked -->
      {% if dom.blocked_epics %}
      <section class="card" style="border-left:4px solid #ea1100; background:#fef2f2">
        <h2 class="text-lg font-bold text-red-700 mb-3">üö´ Bloqueadas en {{ dom.name }}</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead><tr class="text-left text-red-800"><th class="py-2 pr-4">Key</th><th class="pr-4">Summary</th><th class="pr-4">Assignee</th><th>Updated</th></tr></thead>
            <tbody>{% for e in dom.blocked_epics %}<tr class="border-t border-red-200">
              <td class="py-2 pr-4"><a href="{{ e.url }}" target="_blank" class="text-red-700 underline font-mono">{{ e.key }}</a></td>
              <td class="pr-4">{{ e.summary }}</td><td class="pr-4">{{ e.assignee }}</td><td class="text-xs">{{ e.updated }}</td>
            </tr>{% endfor %}</tbody>
          </table>
        </div>
      </section>
      {% endif %}

      <!-- Detail table -->
      <section class="card">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
          <h2 class="text-lg font-bold" style="color:#0053e2">üìù Tickets de {{ dom.name }} ({{ dom.total_issues }})</h2>
          <input type="text" placeholder="Buscar..." class="domain-search border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 w-full sm:w-72" style="--tw-ring-color:#0053e2" data-table="issueTable-{{ dom.slug }}" />
        </div>
        <div class="overflow-x-auto" style="max-height:500px; overflow-y:auto;">
          <table class="w-full text-sm" id="issueTable-{{ dom.slug }}">
            <thead class="sticky top-0 bg-white"><tr class="text-left text-gray-500 border-b text-xs uppercase tracking-wide">
              <th class="py-2 pr-3">Key</th><th class="pr-3">Tipo</th><th class="pr-3">Summary</th>
              <th class="pr-3">Status</th><th class="pr-3">Servicio</th><th class="pr-3">Assignee</th>
              <th class="pr-3">Cycle T.</th><th class="pr-3">Lead T.</th>
            </tr></thead>
            <tbody>
            {% for i in dom.issues %}
            <tr class="border-t border-gray-100 hover:bg-blue-50 cursor-pointer" onclick="window.open('{{ i.url }}','_blank')">
              <td class="py-1.5 pr-3 font-mono text-xs"><a href="{{ i.url }}" target="_blank" class="underline" style="color:#0053e2">{{ i.key }}</a></td>
              <td class="pr-3 text-xs">{{ i.issuetype }}</td>
              <td class="pr-3 text-xs">{{ i.summary[:80] }}</td>
              <td class="pr-3">{% if i.status == 'Listo' %}<span class="badge badge-done">{{ i.status }}</span>{% elif i.status == 'Blocked' %}<span class="badge badge-blocked">{{ i.status }}</span>{% else %}<span class="badge badge-wip">{{ i.status }}</span>{% endif %}</td>
              <td class="pr-3 text-xs">{{ i.servicio or '-' }}</td>
              <td class="pr-3 text-xs">{{ i.assignee }}</td>
              <td class="pr-3 text-xs text-center">{{ i.cycle_time if i.cycle_time is not none else '-' }}</td>
              <td class="pr-3 text-xs text-center">{{ i.lead_time if i.lead_time is not none else '-' }}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>
    {% endfor %}

  </main>

  <footer style="background:#0053e2" class="text-blue-200 text-center py-4 text-sm mt-8">
    CAMDP Epics Dashboard &bull; Walmart M√©xico &bull; {{ generated_at }}
  </footer>

  <!-- ==================== DATA ==================== -->
  <script>
  const GANTT_DATA = {
    general: {{ gantt|tojson }},
    {% for dom in domains %}'{{ dom.slug }}': {{ dom.gantt|tojson }},{% endfor %}
  };
  /* Issue arrays ligeros para filtrado din√°mico */
  const ISSUES_DATA = {
    general: {{ issues_slim|tojson }},
    {% for dom in domains %}'{{ dom.slug }}': {{ dom.issues_slim|tojson }},{% endfor %}
  };
  const DOMAIN_SLUGS = ['general', {% for dom in domains %}'{{ dom.slug }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  </script>
  <script src="dashboard.js"></script>
</body>
</html>
