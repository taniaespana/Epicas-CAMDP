<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAMDP ‚Äî Epics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', system-ui, sans-serif; }
    .card { @apply bg-white rounded-xl shadow-md p-6 border border-gray-100 transition-shadow; }
    .card:hover { box-shadow: 0 4px 24px rgba(0,83,226,0.08); }
    .kpi-value { @apply text-3xl md:text-4xl font-bold; }
    .kpi-label { @apply text-xs text-gray-500 mt-1 uppercase tracking-wide; }
    .badge { @apply px-2.5 py-0.5 rounded-full text-xs font-semibold inline-block; }
    .badge-wip { @apply bg-blue-100 text-blue-800; }
    .badge-done { @apply bg-green-100 text-green-800; }
    .badge-blocked { @apply bg-red-100 text-red-800; }
    .badge-backlog { @apply bg-gray-100 text-gray-700; }
    .filter-pill { @apply px-3 py-1 rounded-full text-xs font-medium cursor-pointer border transition-all; }
    .filter-pill.active { @apply bg-gray-700 text-white border-gray-700; }
    .filter-pill:not(.active) { @apply bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200 hover:text-gray-700; }
    .chart-clickable canvas { cursor: pointer; }
    .domain-tab {
      @apply px-4 py-2 text-sm font-semibold cursor-pointer border-b-2 transition-all whitespace-nowrap;
    }
    .domain-tab.active {
      border-color: #0053e2;
      color: #0053e2;
    }
    .domain-tab:not(.active) {
      border-color: transparent;
      color: #6b7280;
    }
    .domain-tab:not(.active):hover {
      color: #0053e2;
      border-color: #d1d5db;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header style="background:#0053e2" class="text-white py-6 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
          ‚ö° CAMDP Epics Dashboard
        </h1>
        <p class="text-blue-200 text-sm mt-1">Centro de Anal√≠tica, Machine Learning & Data Platform</p>
      </div>
      <div class="text-right text-sm text-blue-200 space-y-0.5">
        <p>Generado: <span class="text-white">{{ generated_at }}</span></p>
        <p>√âpicas: <span class="text-white font-bold">{{ total_epics }}</span> de {{ total_raw }}
           &bull; Issues: <span class="text-white font-bold">{{ total_all_issues }}</span></p>
        <p class="text-xs">Filtro √©picas: abiertas + cerradas desde {{ cutoff_date }}</p>
      </div>
    </div>
  </header>

  <!-- DOMAIN TABS -->
  <nav class="bg-white shadow-sm border-b sticky top-0 z-50" aria-label="Pesta√±as de dominio">
    <div class="max-w-7xl mx-auto px-4 flex overflow-x-auto gap-1">
      <button class="domain-tab active" data-tab="general" onclick="switchTab('general')">
        üåê General
      </button>
      {% for dom in domains %}
      <button class="domain-tab" data-tab="{{ dom.slug }}" onclick="switchTab('{{ dom.slug }}')">
        {{ dom.name }} <span class="text-xs opacity-60">({{ dom.total_issues }})</span>
      </button>
      {% endfor %}
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8">

    <!-- ======================== TAB: GENERAL ======================== -->
    <div id="tab-general" class="tab-content active space-y-6">

      <!-- KPI CARDS -->
      <section class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4" aria-label="KPIs">
        <div class="card text-center">
          <div class="kpi-value" style="color:#0053e2">{{ total_epics }}</div>
          <div class="kpi-label">Total √âpicas</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#2a8703">{{ resolution.resolved }}</div>
          <div class="kpi-label">Resueltas</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#0053e2">{{ active_epics|length }}</div>
          <div class="kpi-label">En Progreso</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#ea1100">{{ blocked_epics|length }}</div>
          <div class="kpi-label">Bloqueadas</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#995213">{{ total_all_issues }}</div>
          <div class="kpi-label">Issues Totales</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#2a8703">{{ resolution.rate_pct }}%</div>
          <div class="kpi-label">Tasa Resol.</div>
        </div>
      </section>

      <!-- EXECUTIVE INSIGHTS -->
      <section class="card" style="border-left:4px solid #0053e2" aria-label="Insights">
        <h2 class="text-lg font-bold mb-2" style="color:#0053e2">üìä An√°lisis Ejecutivo</h2>
        <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
          <li>De <strong>{{ total_raw }}</strong> √©picas hist√≥ricas, se muestran <strong>{{ total_epics }}</strong> relevantes.</li>
          <li><strong>{{ total_all_issues }}</strong> issues totales en el proyecto CAMDP.</li>
          <li><strong>{{ active_epics|length }}</strong> en progreso activo, <strong>{{ resolution.rate_pct }}%</strong> tasa de resoluci√≥n.</li>
          {% if blocked_epics|length > 0 %}
          <li class="text-red-700">‚ö†Ô∏è <strong>{{ blocked_epics|length }}</strong> √©pica(s) bloqueada(s):
            {% for e in blocked_epics %}<code class="bg-red-50 px-1 rounded">{{ e.key }}</code>{% if not loop.last %}, {% endif %}{% endfor %}
          </li>
          {% endif %}
          <li>üí° <em>Usa las pesta√±as de arriba para ver cada dominio.</em></li>
        </ul>
      </section>

      <!-- GANTT GENERAL -->
      <section class="card" aria-label="Gantt general">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
          <div>
            <h3 class="font-bold text-lg" style="color:#0053e2">üìÖ Gantt ‚Äî Timeline General</h3>
            <p class="text-xs text-gray-400 mt-1">
              L√≠nea roja = hoy &nbsp;|&nbsp;
              <span style="color:#2a8703">‚óè En tiempo</span> &nbsp;
              <span style="color:#0053e2">‚óè Extendida</span> &nbsp;
              <span style="color:#ea1100">‚óè Bloqueada</span>
            </p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button class="gantt-pill filter-pill active" data-domain="general" data-status="all" onclick="setGanttFilter('general','all')">Todos</button>
            <button class="gantt-pill filter-pill" data-domain="general" data-status="Work in Progress" onclick="setGanttFilter('general','Work in Progress')">En Progreso</button>
            <button class="gantt-pill filter-pill" data-domain="general" data-status="Blocked" onclick="setGanttFilter('general','Blocked')">Bloqueadas</button>
          </div>
        </div>
        <div style="max-height:900px; overflow-y:auto;">
          <div id="ganttContainer-general" style="min-height:280px;">
            <canvas id="ganttChart-general"></canvas>
          </div>
        </div>
      </section>

      <!-- CHARTS: Status + Issue Types -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üü¢ Estado (√âpicas)</h3>
          <div style="height:280px"><canvas id="statusChart-general"></canvas></div>
        </div>
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üìã Tipos de Issue (Todo CAMDP)</h3>
          <div style="height:280px"><canvas id="issuetypeChart-general"></canvas></div>
        </div>
      </section>

      <!-- CHARTS: Dominio + Equipo -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üè¢ Dominio (√Årea)</h3>
          <div style="height:280px"><canvas id="dominioChart-general"></canvas></div>
        </div>
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üë• Equipo Data Fabric</h3>
          <div style="height:280px"><canvas id="equipoChart-general"></canvas></div>
        </div>
      </section>

      <!-- CHARTS: Assignee + Monthly -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üë§ Top Assignees</h3>
          <div style="height:300px"><canvas id="assigneeChart-general"></canvas></div>
        </div>
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üìÖ Creaci√≥n Mensual</h3>
          <div style="height:300px"><canvas id="monthlyChart-general"></canvas></div>
        </div>
      </section>

      <!-- FULL TABLE -->
      <section class="card" aria-label="Tabla de √©picas">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
          <h2 class="text-lg font-bold" style="color:#0053e2">üìù √âpicas ({{ total_epics }})</h2>
          <input id="searchInput-general" type="text" placeholder="Buscar..."
                 class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 w-full sm:w-72"
                 style="--tw-ring-color:#0053e2" aria-label="Buscar √©pica" />
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" id="epicTable-general">
            <thead>
              <tr class="text-left text-gray-500 border-b text-xs uppercase tracking-wide">
                <th class="py-2 pr-3">Key</th><th class="pr-3">Summary</th>
                <th class="pr-3">Status</th><th class="pr-3">Dominio</th>
                <th class="pr-3">Equipo DF</th><th class="pr-3">Assignee</th>
                <th class="pr-3">Creada</th>
              </tr>
            </thead>
            <tbody>
            {% for e in epics %}
            <tr class="border-t border-gray-100 hover:bg-blue-50 cursor-pointer" onclick="window.open('{{ e.url }}','_blank')">
              <td class="py-2 pr-3 font-mono text-xs">
                <a href="{{ e.url }}" target="_blank" rel="noopener" class="underline" style="color:#0053e2">{{ e.key }}</a>
              </td>
              <td class="pr-3">{{ e.summary }}</td>
              <td class="pr-3">
                {% if e.status == 'Listo' %}<span class="badge badge-done">{{ e.status }}</span>
                {% elif e.status == 'Blocked' %}<span class="badge badge-blocked">{{ e.status }}</span>
                {% elif e.status == 'Backlog' %}<span class="badge badge-backlog">{{ e.status }}</span>
                {% else %}<span class="badge badge-wip">{{ e.status }}</span>{% endif %}
              </td>
              <td class="pr-3 text-xs">{{ e.dominio or '-' }}</td>
              <td class="pr-3 text-xs">{{ e.equipo_df or '-' }}</td>
              <td class="pr-3 text-xs">{{ e.assignee }}</td>
              <td class="pr-3 text-xs">{{ e.created }}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>{# /tab-general #}

    <!-- ======================== DOMAIN TABS ======================== -->
    {% for dom in domains %}
    <div id="tab-{{ dom.slug }}" class="tab-content space-y-6">

      <!-- KPIs -->
      <section class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
        <div class="card text-center">
          <div class="kpi-value" style="color:#0053e2">{{ dom.total_epics }}</div>
          <div class="kpi-label">√âpicas</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#2a8703">{{ dom.resolved }}</div>
          <div class="kpi-label">Resueltas</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#0053e2">{{ dom.active }}</div>
          <div class="kpi-label">En Progreso</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#ea1100">{{ dom.blocked }}</div>
          <div class="kpi-label">Bloqueadas</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#995213">{{ dom.total_issues }}</div>
          <div class="kpi-label">Issues Totales</div>
        </div>
        <div class="card text-center">
          <div class="kpi-value" style="color:#2a8703">{{ dom.resolution_rate }}%</div>
          <div class="kpi-label">Tasa Resol.</div>
        </div>
      </section>

      <!-- GANTT por dominio -->
      {% if dom.gantt %}
      <section class="card">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
          <div>
            <h3 class="font-bold text-lg" style="color:#0053e2">üìÖ Gantt ‚Äî {{ dom.name }}</h3>
            <p class="text-xs text-gray-400 mt-1">
              <span style="color:#2a8703">‚óè En tiempo</span> &nbsp;
              <span style="color:#0053e2">‚óè Extendida</span> &nbsp;
              <span style="color:#ea1100">‚óè Bloqueada</span>
            </p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button class="gantt-pill filter-pill active" data-domain="{{ dom.slug }}" data-status="all" onclick="setGanttFilter('{{ dom.slug }}','all')">Todos</button>
            <button class="gantt-pill filter-pill" data-domain="{{ dom.slug }}" data-status="Work in Progress" onclick="setGanttFilter('{{ dom.slug }}','Work in Progress')">En Progreso</button>
            <button class="gantt-pill filter-pill" data-domain="{{ dom.slug }}" data-status="Blocked" onclick="setGanttFilter('{{ dom.slug }}','Blocked')">Bloqueadas</button>
          </div>
        </div>
        <div style="max-height:700px; overflow-y:auto;">
          <div id="ganttContainer-{{ dom.slug }}" style="min-height:280px;">
            <canvas id="ganttChart-{{ dom.slug }}"></canvas>
          </div>
        </div>
      </section>
      {% else %}
      <section class="card text-center py-12 text-gray-400">
        <p class="text-lg">üìÖ Sin datos de Gantt para este dominio</p>
        <p class="text-sm">Las √©picas no tienen fechas de inicio/fin configuradas.</p>
      </section>
      {% endif %}

      <!-- CHARTS por dominio -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üìã Tipos de Issue</h3>
          <div style="height:280px"><canvas id="issuetypeChart-{{ dom.slug }}"></canvas></div>
        </div>
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üü¢ Estado (Issues)</h3>
          <div style="height:280px"><canvas id="statusChart-{{ dom.slug }}"></canvas></div>
        </div>
      </section>

      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üë§ Assignees</h3>
          <div style="height:300px"><canvas id="assigneeChart-{{ dom.slug }}"></canvas></div>
        </div>
        <div class="card">
          <h3 class="font-bold mb-3" style="color:#0053e2">üìÖ Creaci√≥n Mensual</h3>
          <div style="height:300px"><canvas id="monthlyChart-{{ dom.slug }}"></canvas></div>
        </div>
      </section>

      <!-- Blocked alert -->
      {% if dom.blocked_epics %}
      <section class="card" style="border-left:4px solid #ea1100; background:#fef2f2">
        <h2 class="text-lg font-bold text-red-700 mb-3">üö´ Bloqueadas en {{ dom.name }}</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead><tr class="text-left text-red-800">
              <th class="py-2 pr-4">Key</th><th class="pr-4">Summary</th>
              <th class="pr-4">Assignee</th><th>Updated</th>
            </tr></thead>
            <tbody>
            {% for e in dom.blocked_epics %}
            <tr class="border-t border-red-200">
              <td class="py-2 pr-4"><a href="{{ e.url }}" target="_blank" rel="noopener" class="text-red-700 underline font-mono">{{ e.key }}</a></td>
              <td class="pr-4">{{ e.summary }}</td>
              <td class="pr-4">{{ e.assignee }}</td>
              <td class="text-xs">{{ e.updated }}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
      {% endif %}

      <!-- Epic table per domain -->
      <section class="card">
        <h2 class="text-lg font-bold mb-4" style="color:#0053e2">üìù √âpicas de {{ dom.name }} ({{ dom.total_epics }})</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b text-xs uppercase tracking-wide">
                <th class="py-2 pr-3">Key</th><th class="pr-3">Summary</th>
                <th class="pr-3">Status</th><th class="pr-3">Assignee</th><th class="pr-3">Creada</th>
              </tr>
            </thead>
            <tbody>
            {% for e in dom.epics %}
            <tr class="border-t border-gray-100 hover:bg-blue-50 cursor-pointer" onclick="window.open('{{ e.url }}','_blank')">
              <td class="py-2 pr-3 font-mono text-xs">
                <a href="{{ e.url }}" target="_blank" rel="noopener" class="underline" style="color:#0053e2">{{ e.key }}</a>
              </td>
              <td class="pr-3">{{ e.summary }}</td>
              <td class="pr-3">
                {% if e.status == 'Listo' %}<span class="badge badge-done">{{ e.status }}</span>
                {% elif e.status == 'Blocked' %}<span class="badge badge-blocked">{{ e.status }}</span>
                {% else %}<span class="badge badge-wip">{{ e.status }}</span>{% endif %}
              </td>
              <td class="pr-3 text-xs">{{ e.assignee }}</td>
              <td class="pr-3 text-xs">{{ e.created }}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

    </div>{# /tab-domain #}
    {% endfor %}

  </main>

  <footer style="background:#0053e2" class="text-blue-200 text-center py-4 text-sm mt-8">
    CAMDP Epics Dashboard &bull; Walmart M√©xico &bull; {{ generated_at }}
  </footer>

  <!-- ======================== DATA ======================== -->
  <script>
  const GANTT_DATA = {
    general: {{ gantt|tojson }},
    {% for dom in domains %}
    '{{ dom.slug }}': {{ dom.gantt|tojson }},
    {% endfor %}
  };

  const CHART_DATA = {
    general: {
      status:    { labels: {{ status_dist.keys()|list|tojson }},    values: {{ status_dist.values()|list|tojson }} },
      issuetype: { labels: {{ issuetype_dist.keys()|list|tojson }}, values: {{ issuetype_dist.values()|list|tojson }} },
      dominio:   { labels: {{ dominio_dist.keys()|list|tojson }},   values: {{ dominio_dist.values()|list|tojson }} },
      equipo:    { labels: {{ equipo_df_dist.keys()|list|tojson }}, values: {{ equipo_df_dist.values()|list|tojson }} },
      assignee:  { labels: {{ assignee_dist.keys()|list|tojson }},  values: {{ assignee_dist.values()|list|tojson }} },
      monthly:   { labels: {{ monthly.keys()|list|tojson }},        values: {{ monthly.values()|list|tojson }} },
    },
    {% for dom in domains %}
    '{{ dom.slug }}': {
      issuetype: { labels: {{ dom.issuetype_dist.keys()|list|tojson }}, values: {{ dom.issuetype_dist.values()|list|tojson }} },
      status:    { labels: {{ dom.status_dist.keys()|list|tojson }},    values: {{ dom.status_dist.values()|list|tojson }} },
      assignee:  { labels: {{ dom.assignee_dist.keys()|list|tojson }},  values: {{ dom.assignee_dist.values()|list|tojson }} },
      monthly:   { labels: {{ dom.monthly.keys()|list|tojson }},        values: {{ dom.monthly.values()|list|tojson }} },
    },
    {% endfor %}
  };

  const DOMAIN_SLUGS = ['general', {% for dom in domains %}'{{ dom.slug }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  </script>
  <script src="dashboard.js"></script>
</body>
</html>
