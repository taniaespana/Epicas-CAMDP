<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAMDP ‚Äî Epics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', system-ui, sans-serif; }
    .card { @apply bg-white rounded-xl shadow-md p-6 border border-gray-100 transition-shadow; }
    .card:hover { box-shadow: 0 4px 24px rgba(0,83,226,0.08); }
    .kpi-value { @apply text-3xl md:text-4xl font-bold; }
    .kpi-label { @apply text-xs text-gray-500 mt-1 uppercase tracking-wide; }
    .badge { @apply px-2.5 py-0.5 rounded-full text-xs font-semibold inline-block; }
    .badge-wip { @apply bg-blue-100 text-blue-800; }
    .badge-done { @apply bg-green-100 text-green-800; }
    .badge-blocked { @apply bg-red-100 text-red-800; }
    .badge-backlog { @apply bg-gray-100 text-gray-700; }
    .filter-pill { @apply px-3 py-1 rounded-full text-xs font-medium cursor-pointer border transition-all; }
    .filter-pill.active { @apply text-white border-transparent; background: #0053e2; }
    .filter-pill:not(.active) { @apply bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100; }
    .chart-clickable canvas { cursor: pointer; }
    #epicTable tbody tr { cursor: pointer; transition: background 0.12s; }
    #epicTable tbody tr:hover { background-color: #eff6ff; }
    .active-filter-banner { @apply bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 text-sm text-blue-800 flex items-center justify-between; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header style="background:#0053e2" class="text-white py-6 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
          ‚ö° CAMDP Epics Dashboard
        </h1>
        <p class="text-blue-200 text-sm mt-1">Centro de Anal√≠tica, Machine Learning & Data Platform</p>
      </div>
      <div class="text-right text-sm text-blue-200 space-y-0.5">
        <p>Generado: <span class="text-white">{{ generated_at }}</span></p>
        <p>√âpicas mostradas: <span class="text-white font-bold">{{ total_epics }}</span> de {{ total_raw }}</p>
        <p class="text-xs">Filtro: abiertas + cerradas desde {{ cutoff_date }}</p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-6">

    <!-- KPI CARDS -->
    <section class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4" aria-label="KPIs">
      <div class="card text-center">
        <div class="kpi-value" style="color:#0053e2">{{ total_epics }}</div>
        <div class="kpi-label">Total Filtradas</div>
      </div>
      <div class="card text-center">
        <div class="kpi-value" style="color:#2a8703">{{ resolution.resolved }}</div>
        <div class="kpi-label">Resueltas</div>
      </div>
      <div class="card text-center">
        <div class="kpi-value" style="color:#0053e2">{{ active_epics|length }}</div>
        <div class="kpi-label">En Progreso</div>
      </div>
      <div class="card text-center">
        <div class="kpi-value" style="color:#ea1100">{{ blocked_epics|length }}</div>
        <div class="kpi-label">Bloqueadas</div>
      </div>
      <div class="card text-center">
        <div class="kpi-value" style="color:#995213">{{ resolution.unresolved }}</div>
        <div class="kpi-label">Sin Resolver</div>
      </div>
      <div class="card text-center">
        <div class="kpi-value" style="color:#2a8703">{{ resolution.rate_pct }}%</div>
        <div class="kpi-label">Tasa Resol.</div>
      </div>
    </section>

    <!-- EXECUTIVE INSIGHTS -->
    <section class="card" style="border-left:4px solid #0053e2" aria-label="Insights">
      <h2 class="text-lg font-bold mb-2" style="color:#0053e2">üìä An√°lisis Ejecutivo</h2>
      <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
        <li>De <strong>{{ total_raw }}</strong> √©picas hist√≥ricas, se muestran <strong>{{ total_epics }}</strong> relevantes (abiertas o cerradas desde {{ cutoff_date }}).</li>
        <li><strong>{{ active_epics|length }}</strong> en progreso activo, <strong>{{ resolution.rate_pct }}%</strong> tasa de resoluci√≥n.</li>
        {% if blocked_epics|length > 0 %}
        <li class="text-red-700">‚ö†Ô∏è <strong>{{ blocked_epics|length }}</strong> √©pica(s) bloqueada(s):
          {% for e in blocked_epics %}<code class="bg-red-50 px-1 rounded">{{ e.key }}</code>{% if not loop.last %}, {% endif %}{% endfor %}
        </li>
        {% endif %}
        <li>Dominio l√≠der: <strong>{{ dominio_dist.keys()|list|first|default('N/A') }}</strong> | Equipo DF l√≠der: <strong>{{ equipo_df_dist.keys()|list|first|default('N/A') }}</strong></li>
        <li>üí° <em>Haz click en cualquier gr√°fico para filtrar la tabla de √©picas.</em></li>
      </ul>
    </section>

    <!-- ACTIVE FILTER BANNER (hidden by default) -->
    <div id="filterBanner" class="active-filter-banner hidden">
      <span>üîç Filtro activo: <strong id="filterLabel"></strong></span>
      <button onclick="clearAllFilters()" class="text-blue-600 hover:text-blue-800 font-semibold underline text-xs">Limpiar filtro</button>
    </div>

    <!-- CHARTS ROW 1: Status + Dominio -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card chart-clickable">
        <h3 class="font-bold mb-3" style="color:#0053e2">üü¢ Estado</h3>
        <div style="height:280px"><canvas id="statusChart"></canvas></div>
      </div>
      <div class="card chart-clickable">
        <h3 class="font-bold mb-3" style="color:#0053e2">üè¢ Dominio (√Årea)</h3>
        <div style="height:280px"><canvas id="dominioChart"></canvas></div>
      </div>
    </section>

    <!-- CHARTS ROW 2: Equipo DF + Servicio -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card chart-clickable">
        <h3 class="font-bold mb-3" style="color:#0053e2">üë• Equipo Data Fabric</h3>
        <div style="height:280px"><canvas id="equipoChart"></canvas></div>
      </div>
      <div class="card chart-clickable">
        <h3 class="font-bold mb-3" style="color:#0053e2">‚öôÔ∏è Servicio</h3>
        <div style="height:280px"><canvas id="servicioChart"></canvas></div>
      </div>
    </section>

    <!-- CHARTS ROW 3: App/Producto + Tipo -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card chart-clickable">
        <h3 class="font-bold mb-3" style="color:#0053e2">üì¶ App / Producto</h3>
        <div style="height:280px"><canvas id="appChart"></canvas></div>
      </div>
      <div class="card chart-clickable">
        <h3 class="font-bold mb-3" style="color:#0053e2">üåê Externo / Interno</h3>
        <div style="height:280px"><canvas id="tipoChart"></canvas></div>
      </div>
    </section>

    <!-- CHARTS ROW 4: Assignee + Monthly -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card chart-clickable">
        <h3 class="font-bold mb-3" style="color:#0053e2">üë§ Top Assignees</h3>
        <div style="height:300px"><canvas id="assigneeChart"></canvas></div>
      </div>
      <div class="card chart-clickable">
        <h3 class="font-bold mb-3" style="color:#0053e2">üìÖ Creaci√≥n Mensual</h3>
        <div style="height:300px"><canvas id="monthlyChart"></canvas></div>
      </div>
    </section>

    <!-- BLOCKED ALERT -->
    {% if blocked_epics|length > 0 %}
    <section class="card" style="border-left:4px solid #ea1100; background:#fef2f2" aria-label="Bloqueadas">
      <h2 class="text-lg font-bold text-red-700 mb-3">üö´ √âpicas Bloqueadas</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead><tr class="text-left text-red-800">
            <th class="py-2 pr-4">Key</th><th class="pr-4">Summary</th>
            <th class="pr-4">Dominio</th><th class="pr-4">Assignee</th><th>Updated</th>
          </tr></thead>
          <tbody>
          {% for e in blocked_epics %}
          <tr class="border-t border-red-200">
            <td class="py-2 pr-4"><a href="{{ e.url }}" target="_blank" rel="noopener" class="text-red-700 underline font-mono">{{ e.key }}</a></td>
            <td class="pr-4">{{ e.summary }}</td>
            <td class="pr-4 text-xs">{{ e.dominio or '-' }}</td>
            <td class="pr-4">{{ e.assignee }}</td>
            <td class="text-xs">{{ e.updated }}</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endif %}

    <!-- FULL TABLE -->
    <section class="card" aria-label="Tabla de √©picas">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
        <h2 class="text-lg font-bold" style="color:#0053e2">
          üìù √âpicas (<span id="visibleCount">{{ total_epics }}</span> / {{ total_epics }})
        </h2>
        <input id="searchInput" type="text" placeholder="Buscar..."
               class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 w-full sm:w-72"
               style="--tw-ring-color:#0053e2"
               aria-label="Buscar √©pica" />
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="epicTable">
          <thead>
            <tr class="text-left text-gray-500 border-b text-xs uppercase tracking-wide">
              <th class="py-2 pr-3 cursor-pointer" onclick="sortTable(0)">Key ‚Üï</th>
              <th class="pr-3 cursor-pointer" onclick="sortTable(1)">Summary ‚Üï</th>
              <th class="pr-3 cursor-pointer" onclick="sortTable(2)">Status ‚Üï</th>
              <th class="pr-3 cursor-pointer" onclick="sortTable(3)">Dominio ‚Üï</th>
              <th class="pr-3 cursor-pointer" onclick="sortTable(4)">Equipo DF ‚Üï</th>
              <th class="pr-3 cursor-pointer" onclick="sortTable(5)">Servicio ‚Üï</th>
              <th class="pr-3 cursor-pointer" onclick="sortTable(6)">Assignee ‚Üï</th>
              <th class="pr-3 cursor-pointer" onclick="sortTable(7)">Creada ‚Üï</th>
            </tr>
          </thead>
          <tbody>
          {% for e in epics %}
          <tr class="border-t border-gray-100"
              data-status="{{ e.status }}"
              data-dominio="{{ e.dominio }}"
              data-equipo="{{ e.equipo_df }}"
              data-servicio="{{ e.servicio }}"
              data-app="{{ e.app_producto }}"
              data-tipo="{{ e.tipo }}"
              data-assignee="{{ e.assignee }}"
              data-month="{{ e.created[:7] if e.created else '' }}"
              onclick="window.open('{{ e.url }}','_blank')">
            <td class="py-2 pr-3 font-mono text-xs">
              <a href="{{ e.url }}" target="_blank" rel="noopener" class="underline" style="color:#0053e2">{{ e.key }}</a>
            </td>
            <td class="pr-3">{{ e.summary }}</td>
            <td class="pr-3">
              {% if e.status == 'Listo' %}<span class="badge badge-done">{{ e.status }}</span>
              {% elif e.status == 'Blocked' %}<span class="badge badge-blocked">{{ e.status }}</span>
              {% elif e.status == 'Backlog' %}<span class="badge badge-backlog">{{ e.status }}</span>
              {% else %}<span class="badge badge-wip">{{ e.status }}</span>{% endif %}
            </td>
            <td class="pr-3 text-xs">{{ e.dominio or '-' }}</td>
            <td class="pr-3 text-xs">{{ e.equipo_df or '-' }}</td>
            <td class="pr-3 text-xs">{{ e.servicio or '-' }}</td>
            <td class="pr-3 text-xs">{{ e.assignee }}</td>
            <td class="pr-3 text-xs">{{ e.created }}</td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- RECOMMENDATIONS -->
    <section class="card" style="border-left:4px solid #ffc220" aria-label="Recomendaciones">
      <h2 class="text-lg font-bold mb-2" style="color:#995213">üí° Recomendaciones para Liderazgo</h2>
      <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
        <li>Priorizar las <strong>{{ blocked_epics|length }}</strong> √©picas bloqueadas.</li>
        <li>Revisar carga de assignees ‚Äî el top puede ser cuello de botella.</li>
        <li>Dominios con alto volumen podr√≠an requerir squads adicionales.</li>
        <li>Monitorear tendencia mensual para planificaci√≥n de capacidad.</li>
      </ul>
    </section>
  </main>

  <footer style="background:#0053e2" class="text-blue-200 text-center py-4 text-sm mt-8">
    CAMDP Epics Dashboard &bull; Walmart M√©xico &bull; {{ generated_at }}
  </footer>

  <!-- DATA + INTERACTIVE JS (separate file inlined at build) -->
  <script>
  // ===================== DATA =====================
  const EPICS_DATA = {{ epics|tojson }};
  const CHART_DATA = {
    status:   { labels: {{ status_dist.keys()|list|tojson }},   values: {{ status_dist.values()|list|tojson }} },
    dominio:  { labels: {{ dominio_dist.keys()|list|tojson }},  values: {{ dominio_dist.values()|list|tojson }} },
    equipo:   { labels: {{ equipo_df_dist.keys()|list|tojson }},values: {{ equipo_df_dist.values()|list|tojson }} },
    servicio: { labels: {{ servicio_dist.keys()|list|tojson }}, values: {{ servicio_dist.values()|list|tojson }} },
    app:      { labels: {{ app_dist.keys()|list|tojson }},      values: {{ app_dist.values()|list|tojson }} },
    tipo:     { labels: {{ tipo_dist.keys()|list|tojson }},     values: {{ tipo_dist.values()|list|tojson }} },
    assignee: { labels: {{ assignee_dist.keys()|list|tojson }}, values: {{ assignee_dist.values()|list|tojson }} },
    monthly:  { labels: {{ monthly.keys()|list|tojson }},       values: {{ monthly.values()|list|tojson }} },
  };
  </script>
  <script src="dashboard.js"></script>
</body>
</html>
